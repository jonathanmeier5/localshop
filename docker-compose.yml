version: '3.3'
services:
    db:
        image: postgres:9.6
        environment:
            - PGDATA=/var/lib/postgresql/data/pgdata
            - POSTGRES_DB
            - POSTGRES_USER
            - POSTGRES_PASSWORD
        ports:
            - "5432"
        volumes:
            - docker-localshop-db-data:/var/lib/postgresql/data
        networks:
            - servicenet
        deploy:
            replicas: 1
            resources:
                limits:
                    memory: 256M
                reservations:
                    memory: 256M
                    cpus: '0.1'
            restart_policy:
                delay: 5s
                window: 120s

    web:
        build: .
        image: registry.osslabs.net/localshop
        environment:
            - DJANGO_SECRET_KEY
            - DATABASE_URL
            - DJANGO_MEDIA_ROOT
        command: uwsgi --http 0.0.0.0:8000 --module localshop.wsgi --master --die-on-term
        ports:
            - "8000:8000"
        volumes:
            - docker-localshop-web-data:/opt/localshop
        networks:
            - servicenet
        deploy:
            replicas: 1
            resources:
                limits:
                    memory: 128M
                reservations:
                    memory: 128M
                    cpus: '0.1'
            restart_policy:
                delay: 5s
                window: 120s

    worker:
        image: registry.osslabs.net/localshop
        environment:
            - DJANGO_SECRET_KEY
            - DATABASE_URL
            - DJANGO_MEDIA_ROOT
        entrypoint:
            localshop
        command: celery worker -B -E
        networks:
            - servicenet
        deploy:
            replicas: 1
            resources:
                limits:
                    memory: 128M
                reservations:
                    memory: 128M
                    cpus: '0.1'
            restart_policy:
                delay: 5s
                window: 120s


volumes:
    docker-localshop-db-data:
        external:
            name: docker-localshop-db-data

    docker-localshop-web-data:
        external:
            name: docker-localshop-web-data


networks:
    servicenet:
        driver: overlay
        ipam:
            driver: default
            config:
                - subnet: 192.168.32.80/28
